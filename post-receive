#!/usr/bin/python3 -u

import fcntl
import os
import sys
import subprocess

from git_slug.refsdata import RemoteRefsData
from git_slug.gitconst import REFREPO, REFFILE
from git_slug.gitrepo import GitRepo


data = sys.stdin.readlines()

mail = subprocess.Popen(["./hooks/mailnotification"], stdin=subprocess.PIPE)
for line in data:
    mail.stdin.write(line.encode('utf-8'))
mail.communicate()

gitrepo = os.environ.get('GL_REPO')
if gitrepo.startswith('packages/'):
    gitrepo = gitrepo[len('packages/'):]
else:
    sys.exit()

with open(os.path.join(os.getenv('HOME'), REFREPO, REFFILE), 'r+') as headfile:
    fcntl.lockf(headfile, fcntl.LOCK_EX)
    print('Lock obtained')
    refs = RemoteRefsData(headfile, '*')
    refs.put(gitrepo, data)
    headfile.seek(0)
    headfile.truncate()
    refs.dump(headfile)
    headfile.flush()
    os.fsync(headfile.fileno())
    headrepo = GitRepo(os.path.join(os.getenv('HOME'), REFREPO), os.path.join(os.getenv('GL_REPO_BASE_ABS'), REFREPO+'.git'))
    headrepo.commitfile(REFFILE, 'Changes by {}'.format(os.getenv('GL_USER')))
